<?xml version="1.0" encoding="ISO-8859-1"?>

<product productid="rcd_adv_profile_photo" active="1">
	<title>Advanced Profile Photo</title>
	<description>Advenced profile photo and avatar editing</description>
	<version>0.1</version>
	<url />
	<versioncheckurl />
	<apm_releasedate>0</apm_releasedate>
	<apm_author />
	<apm_relatedurl />
	<apm_extrainfo />
	<apm_extraedit />
	<dependencies>
	</dependencies>
	<codes>
		<code version="0.1">
			<installcode><![CDATA[$db->hide_errors();
$vbulletin->db->query_write("
CREATE TABLE IF NOT EXISTS " . TABLE_PREFIX . "custombigpic (
  `userid` INT UNSIGNED NOT NULL,
  `width` SMALLINT(5) UNSIGNED NOT NULL DEFAULT 0,
  `height` SMALLINT(5) UNSIGNED NOT NULL DEFAULT 0,
  `sel_top` SMALLINT(5) UNSIGNED NOT NULL DEFAULT 0,
  `sel_left` SMALLINT(5) UNSIGNED NOT NULL DEFAULT 0,
  `sel_width` SMALLINT(5) UNSIGNED NOT NULL DEFAULT 0,
  `sel_height` SMALLINT(5) UNSIGNED NOT NULL DEFAULT 0,
  `dateline`  INT NOT NULL DEFAULT 0,
  PRIMARY KEY (`userid`),
  KEY `dateline` (`dateline`, `userid`)
)");
$db->query_write("ALTER TABLE " . TABLE_PREFIX . "user ADD COLUMN `bigpicrevision` INT(10) UNSIGNED NOT NULL DEFAULT 0 ");
$db->query_write("ALTER TABLE " . TABLE_PREFIX . "user ADD COLUMN `bigpicsaved` TINYINT UNSIGNED NOT NULL DEFAULT 0 ");
$db->query_write("ALTER TABLE " . TABLE_PREFIX . "user ADD COLUMN `bigpicpopup` TINYINT UNSIGNED NOT NULL DEFAULT 1 ");
$db->show_errors();]]></installcode>
			<uninstallcode><![CDATA[$db->hide_errors();
$vbulletin->db->query_write("DROP TABLE " . TABLE_PREFIX . "custombigpic");
$db->query_write("ALTER TABLE " . TABLE_PREFIX . "user DROP COLUMN `bigpicrevision`");
$db->query_write("ALTER TABLE " . TABLE_PREFIX . "user DROP COLUMN `bigpicsaved`");
$db->query_write("ALTER TABLE " . TABLE_PREFIX . "user DROP COLUMN `bigpicpopup`");
$db->show_errors();]]></uninstallcode>
		</code>
	</codes>
	<templates>
		<template name="app_editor" templatetype="template" date="1300433607" username="admin" version="0.1"><![CDATA[<div id="app_main_wrapper" class="blockrow app_main_wrapper">
    <vb:if condition="$show['app_editing_options']">
        <div id="app_avatar_result_wrapper" class="avatar_result_wrapper"><p>{vb:rawphrase app_result}</p>
            <img id='avatar_img_selection' src="{vb:raw vboptions.cleargifurl}" />
        </div>
    </vb:if>
    <div style="overflow:hidden;">
        <div class="source_image_wrapper" id="avatar_img_wrap">
            <img src="<vb:if condition="$show['app_editing_options']">{vb:raw path}<vb:else />{vb:stylevar imgdir_misc}/profile_nopic.png</vb:if>" id="avatar_img" />
            <vb:if condition="$show['app_editing_options']">
                <div class="app_resize_mask"></div>
                <div id="app_resize" class="app_resize"></div>
            </vb:if>
        </div>
        <vb:if condition="$show['app_editing_options']">
            <div id="app_clear_div" style="width:100%;clear:both;"></div>
            <div class="checkbox_container">
                <div><input id="app_chkbox_allow_fullsize" type="checkbox" name="app_personality" value="1" <vb:if condition="$vbulletin->userinfo['bigpicpopup']">checked="true"</vb:if>>{vb:rawphrase app_allow_fullsize}<br/></div>
                <div><input id="app_chkbox_confirm_1" type="checkbox" name="app_personality" value="1" disabled='disabled' onclick="APP_Toggle_Next(this);">{vb:rawphrase app_confirm_photo}<br/></div>
                <div id="app_chkbox_confirm_div_2" style="visibility:hidden;"><input id="app_chkbox_confirm_2" type="checkbox" name="app_face_recognition" value="2" onclick="APP_Toggle_Button(this);">{vb:rawphrase app_confirm_photo_face}</div>
            </div>
        </vb:if>
        <div class="app_control_links" id="control_buttons_wrap">
            <form id="app_upload_form" action="ajax.php?do=upload_picture" method="post" enctype="multipart/form-data" target="upload_target" >
                <a href="#" onclick="return false;" id="app_avatarupload_link">{vb:rawphrase upload}</a>
                <input id="avatarupload" type="file" class="primary textbox" name="upload" onchange="APP_Upload_File()"/>
                <input type="hidden" name="s" value="{vb:raw session.sessionhash}" />
                <input type="hidden" name="ajax" value="1" />
                <input type="hidden" name="securitytoken" value="{vb:raw bbuserinfo.securitytoken}" />
                <img src="{vb:stylevar imgdir_misc}/progress.gif" alt="" border="0" id="app_progress" style="display:none;"/>
            </form>
            <vb:if condition="$show['app_editing_options']">
                <a href="#" onclick="APP_DeletePicture(); return false;" rel="nofollow" class="app_zindex">{vb:rawphrase delete}</a>
            </vb:if>
        </div>
    </div>
    <vb:if condition="$show['app_editing_options']">
        <div id="save_button_wrap" class="button_container">
            <input id="app_save_button" class="button" type="button" name="submit" value="{vb:rawphrase app_save}" disabled="disabled" onclick="appEditor.savePicture();">
        </div>
    </vb:if>
<script type="text/javascript">
<!--
<vb:if condition="$show['app_not_ajax_saved_pic']">
    var app_img_width = {vb:raw width};
    var app_img_height = {vb:raw height};
    var app_sel_top = {vb:raw top};
    var app_sel_left = {vb:raw left};
    var app_sel_width = {vb:raw sel_width};
    var app_sel_height = {vb:raw sel_height};
    var app_min_length = {vb:raw min_length};
</vb:if>
<vb:if condition="$show['app_not_ajax_no_pic']">
    var app_img_width = {vb:raw width};
    var app_img_height = {vb:raw height};
    APP_CenterImage({vb:raw width});
</vb:if>
// -->
</script>
</div>]]></template>
		<template name="app_editor_css" templatetype="template" date="1300068273" username="admin" version="0.1"><![CDATA[<!-- Skin CSS file -->
<link rel="stylesheet" type="text/css" href="{vb:stylevar yuipath}/assets/skins/sam/resize.css">
<link rel="stylesheet" type="text/css" href="{vb:stylevar yuipath}/assets/skins/sam/imagecropper.css">

<style type="text/css">

.yui-resize {
    border: 1px dashed #fff !important;   
}

.yui-resize-handle {
    background-color:#F2F2F2;
}

.yui-resize-handle-inner-l, .yui-resize-handle-inner-r {
    background:transparent url({vb:stylevar yuipath}/assets/skins/sam/layout_sprite.png) no-repeat 0 -5px;
    height:16px;
    width:5px;
    position:absolute;
    top:45%;
}
.yui-resize-handle-inner-t, .yui-resize-handle-inner-b {
    background:url({vb:stylevar yuipath}/assets/skins/sam/layout_sprite.png) no-repeat scroll -20px 0 transparent;
    height:5px;
    width:16px;
    position:absolute;
    left:50%;
}

.yui-resize-handle-br {
    background:url({vb:stylevar yuipath}/assets/skins/sam/layout_sprite.png) no-repeat scroll -22px -62px transparent;
}

.yui-resize-handle-tr {
    background:url({vb:stylevar yuipath}/assets/skins/sam/layout_sprite.png) no-repeat scroll -22px -42px transparent;
}

.yui-resize-handle-tl {
    background:url({vb:stylevar yuipath}/assets/skins/sam/layout_sprite.png) no-repeat scroll -22px -82px transparent;
}

.yui-resize-handle-bl {
    background:url({vb:stylevar yuipath}/assets/skins/sam/layout_sprite.png) no-repeat scroll -22px -23px transparent;
}

.app_main_wrapper {
    position:relative;
    width:800px;
    left:50%;
    margin-left:-400px;
}

.avatar_result_wrapper {
    top:10;
    right:-{vb:math {vb:raw min_size}/3 }px;
    position:absolute;
    z-index:2;
    width:{vb:raw min_size}px;
    -moz-border-radius:{vb:raw radius}px;
    -webkit-border-radius:{vb:raw radius}px;
    border:1px solid;
    padding:{vb:stylevar padding};
    margin-top:{vb:stylevar padding};
    background-color: white;
    text-align:center;
}

.avatar_result_wrapper p {
    text-align:left;
}

.avatar_result_wrapper img {
    overflow:hidden;
}

#app_upload_form {
    display:inline;
}

.checkbox_container {
    float:left;
    padding-top:{vb:stylevar padding};
    width:auto;
}

.button_container {
    text-align:right;
    padding-top:20px;
}

.source_image_wrapper {
    left:50%;
    position:relative;
}

.app_resize {
    position:absolute;
}

.app_resize_mask {
    position: absolute;
    left: 0pt;
    top: 0pt;
    width: 100%;
    height: 100%;
    background-color: #000000;
    opacity: 0.5;
    -ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=50)";
    filter: alpha(opacity=50);
}

.app_note {
    padding:{vb:stylevar padding};
}

.app_contour {
    border: {vb:stylevar tabslight_border};
}

.app_contour .button[disabled] {
    opacity:0.5;
    -ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=50)";
    filter: alpha(opacity=50);
}

.app_control_links {
    text-align:right;
    padding-top:{vb:stylevar padding};
    position:relative;
    float:right;
    width:auto;
}

.app_control_links a {
    margin-left:{vb:stylevar padding};
    text-decoration:underline;
}

#avatarupload {
    opacity:0;
    -ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";
    filter: alpha(opacity=0);
    z-index:2;
    top:0px;
    position:absolute;
    margin-top:{vb:stylevar padding};
}

.app_zindex {
    z-index:3;
}
</style>]]></template>
		<template name="app_editor_init_js" templatetype="template" date="1299219233" username="admin" version="0.1"><![CDATA[<script type="text/javascript">
<!--
    appEditor.initPicture();
//-->
</script>]]></template>
		<template name="app_editor_js" templatetype="template" date="1300434706" username="admin" version="0.1"><![CDATA[<script type="text/javascript" src="clientscript/advanced_profile_photo_editor.js?v={vb:raw version}"></script>
<script type="text/javascript" src="{vb:stylevar yuipath}/connection/connection.js?v={vb:raw vboptions.simpleversion}"></script>
<script src="{vb:stylevar yuipath}/dragdrop/dragdrop-min.js?v={vb:raw vboptions.simpleversion}"></script> 
<script src="{vb:stylevar yuipath}/element/element-min.js?v={vb:raw vboptions.simpleversion}"></script> 
<!-- Source file for the Resize Utility -->
<script src="{vb:stylevar yuipath}/resize/resize-min.js?v={vb:raw vboptions.simpleversion}"></script>]]></template>
		<template name="app_popup_css" templatetype="template" date="1300084898" username="admin" version="0.1"><![CDATA[<style type="text/css">
.app_popup {
  padding:none;
  margin:none;
  width:auto;
  height:auto;
  position:absolute;
}

.app_popup ul {
  -moz-border-radius:{vb:stylevar border_radius};
  -webkit-border-radius:{vb:stylevar border_radius};
  direction:ltr;
  margin:none;
  border:1px solid {vb:stylevar navbar_tab_background.backgroundColor};
  background:{vb:stylevar navbar_tab_background.backgroundColor};
  width:auto;
  position:absolute;
  top:50%;
  padding:{vb:stylevar popupmenu_padding};
}

.app_popup img {
  padding:{vb:stylevar padding};
  background:{vb:stylevar formrow_background.backgroundColor} bottom repeat-x;
}

.app_popup_link {
  cursor: pointer;
  cursor: hand;
  float:left;
  visibility:hidden;
}
</style>]]></template>
		<template name="app_popup_init_js" templatetype="template" date="1299045144" username="admin" version="0.1"><![CDATA[<script type="text/javascript">
<!--
appPopup.init('posts');
//-->
</script>]]></template>
		<template name="app_popup_js" templatetype="template" date="1300434722" username="admin" version="0.1"><![CDATA[<script type="text/javascript" src="clientscript/advanced_profile_photo_popup.js?v={vb:raw version}"></script>
<vb:if condition="!isset($show['yui_menu_exists'])">
<script type="text/javascript" src="{vb:stylevar yuipath}/yahoo-dom-event/yahoo-dom-event.js?v={vb:raw vboptions.simpleversion}"></script>
<script type="text/javascript" src="{vb:stylevar yuipath}/container/container_core-min.js?v={vb:raw vboptions.simpleversion}"></script>
<script type="text/javascript" src="{vb:stylevar yuipath}/menu/menu-min.js?v={vb:raw vboptions.simpleversion}"></script>
</vb:if>
<vb:if condition="!isset($show['yui_animation_exists'])">
<script type="text/javascript" src="{vb:stylevar yuipath}/animation/animation-min.js?v={vb:raw vboptions.simpleversion}"></script>
</vb:if>]]></template>
		<template name="app_popup_menu" templatetype="template" date="1300338169" username="admin" version="0.1"><![CDATA[<div id="app_popup_menu">
 <div class="app_popup">
  <ul id="app_popup_inner_menu"><li><img id="app_popup_img" src="" /></li></ul>
 </div>
</div>
<script type="text/javascript">
<!--
    var app_item_ids = [{vb:raw post_ids}];
    var app_pic_names = [{vb:raw pic_paths}];
    var app_pic_path = "{vb:raw pic_folder}";
//-->
</script>]]></template>
		<template name="app_usercp_shell_no_menu" templatetype="template" date="1296442187" username="admin" version="0.1"><![CDATA[{vb:stylevar htmldoctype}
<html xmlns="http://www.w3.org/1999/xhtml"<vb:if condition="$vboptions['enablefacebookconnect']"> xmlns:fb="http://www.facebook.com/2008/fbml"</vb:if> dir="{vb:stylevar textdirection}" lang="{vb:stylevar languagecode}" id="vbulletin_html">
<head>
	{vb:raw headinclude}
	<vb:if condition="$vboptions['storecssasfile']">
		{vb:cssfile usercp-rollup.css}
		<vb:if condition="$includecss">
			<vb:each from="includecss" value="file">
				{vb:cssfile {vb:raw file}}
			</vb:each>
		</vb:if>
	<vb:else />
		{vb:cssfile attachments.css,forumbits.css,forumdisplay.css,postlist.css,projecttools.css,threadlist.css,usercp.css,{vb:raw includecss}}
	</vb:if>

	<vb:if condition="THIS_SCRIPT == 'subscription'"><script type="text/javascript" src="clientscript/vbulletin-threadbit.js?v={vb:raw vboptions.simpleversion}"></script></vb:if>

	<!--[if lt IE 8]>
	<script type="text/javascript" src="clientscript/vbulletin-threadlist-ie.js?v={vb:raw vboptions.simpleversion}"></script>
	{vb:cssfile forumbits-ie.css,forumdisplay-ie.css,postlist-ie.css,threadlist-ie.css,usercp-ie.css,{vb:raw includeiecss}}
	<noscript>
	<style type="text/css">
	.threadinfo { width:59.9%; }
	.threadstats { width:15%; }
	.threadlastpost { width:25%; }
	</style>
	</noscript>
	<![endif]-->

	{vb:raw clientscripts}
	<title>{vb:raw pagetitle} - {vb:raw vboptions.bbtitle}</title>
        {vb:raw headinclude_bottom}
</head>
<body>
{vb:raw header}
{vb:raw navbar}
<vb:comment>
<div id="pagetitle">
	<h1>{vb:raw pagetitle}</h1>
	<p class="description">{vb:raw pagedescription}</p>
</div>
</vb:comment>
<div id="usercp_content">
    <div class="cp_content" style="margin-left: 0px;">
        <div class="blockbody app_contour">
            <div class="section" style="border:none;">
                <p class="app_note">{vb:rawphrase app_annotation}</p>
                {vb:raw HTML}
            </div>
        </div>
    </div>
</div>
{vb:raw footer}
</body>
</html>]]></template>
	</templates>
	<stylevardfns>
	</stylevardfns>
	<stylevars>
	</stylevars>
	<plugins>
		<plugin active="1" executionorder="5">
			<title><![CDATA[Rebuild avatars & profilepics]]></title>
			<hookname>admin_maintenance</hookname>
			<phpcode><![CDATA[//Add option to admin maintenance menu
if ($_REQUEST['do'] == 'chooser')
{
    print_form_header('misc', 'rebuildprofileimageavatars');
    print_table_header($vbphrase['app_rebuild_profile_photo_avatar_thumbnails'], 2, 0);
    print_input_row($vbphrase['app_number_of_pics_to_process_per_cycle'], 'perpage', 200);
    print_yes_no_row($vbphrase['app_include_automatic_javascript_redirect'], 'autoredirect', 1);
    print_submit_row($vbphrase['app_rebuild_profile_photo_avatar_thumbnails']);
}

// Rebuild avatars
if ($_REQUEST['do'] == 'rebuildprofileimageavatars')
{
    $vbulletin->input->clean_array_gpc('r', array(
        'autoredirect' => TYPE_BOOL,
    ));

    if (($memory_limit = ini_size_to_bytes(@ini_get('memory_limit'))) < 128 * 1024 * 1024 AND $memory_limit > 0)
    {
        @ini_set('memory_limit', 128 * 1024 * 1024);
    }

    if ($vbulletin->options['imagetype'] != 'Magick' AND !function_exists('imagetypes'))
    {
        print_stop_message('your_version_no_image_support');
    }

    if (empty($vbulletin->GPC['perpage']))
    {
        $vbulletin->GPC['perpage'] = 20;
    }

    if (!$vbulletin->GPC['startat'])
    {
      $firstattach = $db->query_first("SELECT MIN(userid) AS min FROM " . TABLE_PREFIX . "user");
      $vbulletin->GPC['startat'] = intval($firstattach['min']);
    }

    $userpics = $db->query_read("
    SELECT
      U.userid, U.bigpicsaved, U.bigpicrevision, U.avatarid, U.avatarrevision, U.profilepicrevision,
      B.sel_width AS `SelWidth`,B.sel_height AS `SelHeight`,B.sel_top AS `Top`, B.sel_left AS `Left`
    FROM
                " . TABLE_PREFIX . "user             AS U
      LEFT JOIN " . TABLE_PREFIX . "custombigpic     AS B ON( B.userid = U.userid )
    WHERE
     U.userid >= " . $vbulletin->GPC['startat'] . " AND U.bigpicsaved = 1
    ORDER BY
      U.userid
    LIMIT
      " . $vbulletin->GPC['perpage']
    );

    $finishat = $vbulletin->GPC['startat'];

    while ($userpic = $db->fetch_array($userpics))
    {
        // if user has predefined avatar (not custom) - delete it
        if ($userpic['avatarid'] > 0)
        {
            $_userinfo = fetch_userinfo($userpic['userid']);
            $userdata =& datamanager_init('User', $vbulletin, ERRTYPE_STANDARD);
            $userdata->set_existing($_userinfo);
            $userdata->set('avatarid', 0);
            $userdata->save();

            unset($userdata);
        }

        require_once DIR . '/includes/class_advanced_profile_photo.php';
        $target_path = $vbulletin->options['app_img_folder']."/".$userpic['userid']."_".$userpic['bigpicrevision'].".jpg";

        $img_editor = new vB_AdvancedProfilePhoto_Store($target_path);
        if ($img_editor)
        {
            $img_editor->generate_avatar($userpic['userid'], $userpic['avatarrevision'], $userpic['SelWidth'], $userpic['SelHeight'], $userpic['Left'], $userpic['Top']);
            $img_editor->generate_profilepic($userpic['userid'], $userpic['profilepicrevision'], $userpic['SelWidth'], $userpic['SelHeight'], $userpic['Left'], $userpic['Top']);
        }
        else
        {
            error_log("Unable to open user's big pic on path " . $target_path);
        }
        unset($img_editor);

        vbflush();

        $finishat = ($userpic['userid'] > $finishat ? $userpic['userid'] : $finishat);
        unset($_userinfo);
    }

    $finishat++;
    if ($checkmore = $db->query_first("SELECT userid FROM " . TABLE_PREFIX . "user WHERE userid >= $finishat LIMIT 1"))
    {
        if ($vbulletin->GPC['autoredirect'] == 1)
        {
            print_cp_redirect("misc.php?" . $vbulletin->session->vars['sessionurl'] . "do=rebuildprofileimageavatars&amp;startat=$finishat&amp;pp=" . $vbulletin->GPC['perpage'] . "&amp;autoredirect=1");
        }
        echo "<p><a href=\"misc.php?" . $vbulletin->session->vars['sessionurl'] . "do=rebuildprofileimageavatars&amp;startat=$finishat&amp;pp=" . $vbulletin->GPC['perpage'] . '">' . $vbphrase['click_here_to_continue_processing'] . "</a></p>";
    }
    else
    {
        define('CP_REDIRECT', 'misc.php');
        print_stop_message('rebuilt_avatar_thumbnails_successfully');
    }
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Moderate profile photos</title>
			<hookname>admin_maintenance</hookname>
			<phpcode><![CDATA[// Add option to admin maintenance menu
if ($_REQUEST['do'] == 'chooser')
{
    print_form_header('misc', 'removesmallprofilephoto');
    print_table_header($vbphrase['app_remove_small_profile_photo'], 2, 0);
    print_input_row($vbphrase['app_number_of_profilepic_to_process_per_cycle'], 'perpage', 100);
//    print_yes_no_row($vbphrase['app_order_by_date'], 'orderbydate', 1);
    print_submit_row($vbphrase['app_remove_small_profile_photo']);
}
// Form photos list
if ($_REQUEST['do'] == 'removesmallprofilephoto')
{
    $vbulletin->input->clean_array_gpc('r', array(
        'perpage' => TYPE_INT,
        'orderbydate' => TYPE_BOOL,
        'lastid' => TYPE_INT,
        'lastdateline' => TYPE_INT,
        'todeletelist' => TYPE_ARRAY,
    ));

    if (!$vbulletin->GPC_exists['orderbydate'])
    {
        $vbulletin->GPC['orderbydate'] = true;
    }

    if (!empty($vbulletin->GPC['todeletelist']))
    {
        foreach ($vbulletin->GPC['todeletelist'] as $user_id)
        {
            // avatar and big pic would be deleted automatically (userpicdata_delete)
            $userpic =& datamanager_init('Userpic_Profilepic', $vbulletin, ERRTYPE_STANDARD, 'userpic');
            $userpic->condition = "userid = " . $user_id;
            $userpic->delete();
            echo 'Deleted profile photo and avatar for user_id =' . $user_id;
            echo '<br />';
        }
        echo '<hr />';
    }
    $sql ="SELECT
              U.userid
            FROM
                " . TABLE_PREFIX . "user             AS U
            LEFT JOIN
                " . TABLE_PREFIX . "customprofilepic AS P ON (P.userid = U.userid)
            WHERE P.width > 0";
    if ($vbulletin->GPC['orderbydate'] AND $vbulletin->GPC['lastdateline'] > 0)
    {
        $sql .= "  AND P.dateline < " . $vbulletin->GPC['lastdateline'];
    }
    elseif ($vbulletin->GPC['lastid'] > 0)
    {
        $sql .= "  AND U.userid < " . $vbulletin->GPC['lastid'];
    }
    $sql .= "
            ORDER BY
                " . ($vbulletin->GPC['orderbydate'] ? "P.dateline" : "U.userid") . " DESC
            LIMIT
                " . $vbulletin->GPC['perpage'];
    $profilepics = $db->query_read($sql);
    print_form_header('misc', 'removesmallprofilephoto');

    while ($profilepic = $db->fetch_array($profilepics))
    {
        $userinfo = fetch_userinfo($profilepic['userid'], FETCH_USERINFO_PROFILEPIC);
        cache_permissions($userinfo);
        $img_src = '../' .$vbulletin->options['profilepicurl'] . '/profilepic' . $profilepic['userid'] . '_' . $userinfo['profilepicrevision'] . '.gif';
        echo '<input type="checkbox" name="todeletelist['. $i.']" value="'. $profilepic['userid'] . '" />';
        echo '   <img src="'. $img_src . '" />';
        echo "&nbsp;" . '   <a href="../member.php?do=getinfo&u='. $profilepic['userid'] . '">'. $userinfo['username'] . "</a>";
        echo vbdate('d-m-Y', $userinfo['profilepicdateline'], false, false);
        echo '<br><br>';
    }
    if (isset($userinfo))
    {
        echo '<input type="hidden" name="lastid" value="'. $userinfo['userid'] . '" />';
        echo '<input type="hidden" name="lastdateline" value="'. $userinfo['profilepicdateline'] . '" />';
        echo '<input type="hidden" name="perpage" value="'. $vbulletin->GPC['perpage'] . '" />';
        echo '<input type="hidden" name="orderbydate" value="'. $vbulletin->GPC['orderbydate'] . '" />';
        echo '<input type="submit" value="Next" />';
    }
    else
    {
        echo '<h1>The end</h1>';
    }
    echo '</form>';
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Upload and resize big profile pic</title>
			<hookname>ajax_complete</hookname>
			<phpcode><![CDATA[if ($_POST['do'] == 'upload_picture' AND $show['member'])
{
    $tmp_file_path = tempnam(sys_get_temp_dir(), "vb_bp");
    if(move_uploaded_file($_FILES['upload']['tmp_name'], $tmp_file_path))
    {
        require_once DIR . '/includes/class_advanced_profile_photo.php';
        $img_editor = new vB_AdvancedProfilePhoto($tmp_file_path);
        if (!$img_editor)
        {
            @unlink($tmp_file_path);
            standard_error(fetch_error('upload_invalid_image'));
        }

        $min_size = $vbulletin->options['app_avatar_size'];
        if ($img_editor->get_width() < $min_size OR $img_editor->get_height() < $min_size)
        {
            @unlink($tmp_file_path);
            standard_error(fetch_error('app_image_too_small',$min_size));
        }

        $selection_width = $min_size;
        $selection_height = $min_size;

        // delete old profile pic (avatar and big pic would be deleted automatically)
        $userpic =& datamanager_init('Userpic_Profilepic', $vbulletin, ERRTYPE_STANDARD, 'userpic');
        $userpic->condition = "userid = " . $vbulletin->userinfo['userid'];
        $userpic->delete();

        // if user had predefined avatar - delete it
        if ($vbulletin->userinfo['avatarid'] > 0)
        {
            $userdata =& datamanager_init('User', $vbulletin, ERRTYPE_STANDARD);
            $userdata->set_existing($vbulletin->userinfo);
            $userdata->set('avatarid', 0);
            $userdata->save();
            unset($userdata);
        }

        $img_height = $img_editor->get_height();
        $img_width = $img_editor->get_width();
        if ($img_width > vB_AdvancedProfilePhoto::MAX_WIDTH OR $img_height > vB_AdvancedProfilePhoto::MAX_HEIGHT)
        {
            $img_editor->img_resize_from_src(vB_AdvancedProfilePhoto::MAX_WIDTH, vB_AdvancedProfilePhoto::MAX_HEIGHT);
        }

        $new_path = $vbulletin->options['app_img_folder']."/". $vbulletin->userinfo['userid']."_".($vbulletin->userinfo['bigpicrevision'] + 1).".jpg";
        $new_url = $vbulletin->options['app_img_url']."/". $vbulletin->userinfo['userid']."_".($vbulletin->userinfo['bigpicrevision'] + 1).".jpg";
        $img_editor->save_to_file($new_path);
        @unlink($tmp_file_path);

        // change revision of uploaded file
        $vbulletin->db->query_write("UPDATE " . TABLE_PREFIX . "user SET `bigpicrevision` = ". ($vbulletin->userinfo['bigpicrevision'] + 1) ."
                                     WHERE userid = ". $vbulletin->userinfo['userid']);

        // store data about the file
        $vbulletin->db->query_write("REPLACE INTO " . TABLE_PREFIX . "custombigpic
                                     SET `userid` = " . $vbulletin->userinfo['userid'] .",`width`= ". $img_editor->get_width() .", `height` = ". $img_editor->get_height());


        $left = 0; $top = 0;

        if (function_exists('face_detect'))
        {
            // Face detect
            $faces = face_detect($new_path, $vbulletin->options['app_opencv_cascades_path'].'/haarcascade_frontalface_alt.xml');

            if (!is_array($faces) OR empty($faces))
            {
            }
            else if (count($faces) > 1)
            {
            }
            else
            {
                $left = $faces[0]['x'];
                $top = $faces[0]['y'];
                $selection_width = $faces[0]['w'];
                $selection_height = $faces[0]['h'];

                // we will increase the area 20%, because hairs and chin could be cropped
                $sel_scale_size = ceil(min($selection_width, $selection_height) * 1.2);
                // if selection scale is still smaller than min size, then set it to min_size
                if ($sel_scale_size < $min_size)
                {
                    $sel_scale_size = $min_size;
                }

                // scale x
                $part = ceil(($sel_scale_size - $selection_width)/2);
                $left-= $part;
                $selection_width = $sel_scale_size;

                if ($left < 0)
                {
                    $left = 0;
                }

                if ($left + $selection_width > $img_width)
                {
                    $left = $img_width - $selection_width;
                }

                // scale y
                $part = ceil(($sel_scale_size - $selection_height)/2);
                $top-= $part;
                $selection_height = $sel_scale_size;

                if ($top < 0)
                {
                    $top = 0;
                }

                if ($top + $selection_height > $img_height)
                {
                    $top = $img_height - $selection_height;
                }
            }
        }

        $show['app_editing_options'] = true;
        $templater = vB_Template::create('app_editor');
        $templater->register('path', $new_url);
        // create response for ajax
        require_once(DIR . '/includes/class_xml.php');

        $xml = new vB_AJAX_XML_Builder($vbulletin, 'text/xml');
        $xml->add_group('image_data');
        $xml->add_tag('image_html', $templater->render());
        $xml->add_tag('width', $img_editor->get_width());
        $xml->add_tag('height', $img_editor->get_height());
        $xml->add_tag('top', $top);
        $xml->add_tag('left', $left);
        $xml->add_tag('sel_width', $selection_width);
        $xml->add_tag('sel_height', $selection_height);
        $xml->add_tag('min_length', $min_size);     
        $xml->close_group();
        $xml->print_xml(); 
    }
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Cache templates</title>
			<hookname>cache_templates</hookname>
			<phpcode><![CDATA[if (THIS_SCRIPT == 'profile' AND $_REQUEST['do'] == 'editprofilepic')
{
    $cache[] = 'app_usercp_shell_no_menu';
    $cache[] = 'app_editor';
    $cache[] = 'app_editor_js';
    $cache[] = 'app_editor_css';
    $cache[] = 'app_editor_init_js';
}

if (THIS_SCRIPT == 'ajax' AND $_POST['do'] == 'upload_picture' AND $show['member'])
{
    $cache[] = 'app_editor';
}

if (THIS_SCRIPT == 'showthread')
{
    $cache[] = 'app_popup_js';
    $cache[] = 'app_popup_css';
    $cache[] = 'app_popup_init_js';
    $cache[] = 'app_popup_menu';
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Delete not saved big pics</title>
			<hookname>cron_script_cleanup_daily</hookname>
			<phpcode><![CDATA[// set to 7 days
define('TIMECUTOFF', 7*24*60*60);

// Get all uploaded, but not saved big pics
$bigpics = $vbulletin->db->query_read("SELECT user.userid, user.bigpicrevision FROM " . TABLE_PREFIX . "custombigpic AS bigpic
                                       INNER JOIN " . TABLE_PREFIX . "user AS user ON (user.userid = bigpic.userid AND user.bigpicsaved = 0)
                                       WHERE bigpic.dateline >= ". (TIMENOW - TIMECUTOFF));

$userids = array();
$file_paths = array();

while ($bigpic = $vbulletin->db->fetch_array($bigpics))
{
    @unlink($vbulletin->options['app_img_folder']."/".$bigpic['userid']."_".$bigpic['bigpicrevision'].".jpg");
    $userids[] = $bigpic['userid'];
}

if (!empty($userids))
{
    $vbulletin->db->query_write("DELETE FROM " . TABLE_PREFIX . "custombigpic WHERE userid IN (" . implode(",", $userids) . ")");
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Disable avatar edit link in left block</title>
			<hookname>global_bootstrap_complete</hookname>
			<phpcode><![CDATA[// this variable is used in several files (subscribe.php, profile.php etc)
// so we disabled it globally
global $show;
$show['avatarlink'] = false;]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Insert js and css</title>
			<hookname>parse_templates</hookname>
			<phpcode><![CDATA[//define product version and assign it to JS version
define('APP_VERSION', '0.1c');

if (THIS_SCRIPT == 'profile' AND $_REQUEST['do'] == 'editprofilepic')
{
    $version = (!$vbulletin->debug) ? APP_VERSION : TIMENOW;
    $templater = vB_Template::create('app_editor_js');
    $templater->register('version', $version);
    $template_hook['headinclude_javascript'] .= $templater->render();

    $templater = vB_Template::create('app_editor_css');
    $templater->register('min_size', $vbulletin->options['app_avatar_size']);
    $templater ->register('radius', $vbulletin->options['app_corners_radius']);
    $template_hook['headinclude_bottom_css'] .= $templater->render();

    $templater = vB_Template::create('app_editor_init_js');
    $template_hook['footer_javascript'] .= $templater->render();
}

if (THIS_SCRIPT == 'showthread')
{
    $version = (!$vbulletin->debug) ? APP_VERSION : TIMENOW;
    
    $templater = vB_Template::create('app_popup_js');
    $templater->register('version', $version);
    $template_hook['headinclude_javascript'] .= $templater->render();

    $templater = vB_Template::create('app_popup_css');
    $template_hook['headinclude_bottom_css'] .= $templater->render();

    $templater = vB_Template::create('app_popup_init_js');
    $template_hook['footer_javascript'] .= $templater->render();

    if (!$show['yui_menu_exists'])
    {
        $show['yui_menu_exists'] = true;
    }
    if (!$show['yui_animation_exists'])
    {
        $show['yui_animation_exists'] = true;
    }
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Replace profile templates</title>
			<hookname>profile_complete</hookname>
			<phpcode><![CDATA[if ($_REQUEST['do'] == 'editprofilepic')
{
    global $shelltemplatename;
    $shelltemplatename = 'app_usercp_shell_no_menu';

    global $page_templater;
    $page_templater = vB_Template::create('app_editor');
    $img_path = '';
    $bigpic = $db->query_first("SELECT `sel_top`, `sel_left`, `sel_width`, `sel_height`, `width`, `height`
			FROM " . TABLE_PREFIX . "custombigpic
			WHERE userid = " . $vbulletin->userinfo['userid']);

    // display big pic only when its exist and user has profile pic
    if ($show['profilepic'] AND $bigpic)
    {
        $show['app_editing_options'] = true;
        $show['app_not_ajax_saved_pic'] = true;
        $img_path = $vbulletin->options['app_img_url']."/".$vbulletin->userinfo['userid']."_".$vbulletin->userinfo['bigpicrevision'].".jpg";
        
        $page_templater->register('top', $bigpic["sel_top"]);
        $page_templater->register('left', $bigpic["sel_left"]);
        $page_templater->register('width', $bigpic["width"]);
        $page_templater->register('height', $bigpic["height"]);

        $sel_width = $bigpic["sel_width"];
        if ($sel_width == 0)
        {
            $sel_width = $vbulletin->options['app_avatar_size'];
        }
        $sel_height = $bigpic["sel_height"];
        if ($sel_height == 0)
        {
            $sel_height = $vbulletin->options['app_avatar_size'];
        }
        $page_templater->register('sel_width', $sel_width);
        $page_templater->register('sel_height', $sel_height);
        $page_templater->register('min_length', $vbulletin->options['app_avatar_size']);
    }
    else
    {
        $show['app_editing_options'] = false;
        $show['app_not_ajax_no_pic'] = true;
        $imgsize = getimagesize("images/misc/profile_nopic.png");
        // DON'T REMOVE. We are sending width to template to center div.
        // Later this width would be changed with new uploaded image (by AJAX). That is why we don't hardcode width in css
        $page_templater->register('width', $imgsize[0]);
        $page_templater->register('height', $imgsize[1]);
    }

    $page_templater->register("path", $img_path);
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Deny avatar edit</title>
			<hookname>profile_start</hookname>
			<phpcode><![CDATA[if (($_POST['do'] == 'updateavatar') OR ($_REQUEST['do'] == 'editavatar'))
{
    $vbulletin->options['avatarenabled'] = false;
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Save pictures</title>
			<hookname>profile_start</hookname>
			<phpcode><![CDATA[if ($_POST['do'] == 'save_picture' AND $show['member'])
{
    $vbulletin->input->clean_array_gpc('r', array(
        'top' => TYPE_UINT,
        'left' => TYPE_UINT,
        'height' => TYPE_UINT,
        'width' => TYPE_UINT,
        'enablepreview' => TYPE_UINT
    ));

    require_once DIR . '/includes/class_advanced_profile_photo.php';
    // safety checks
    $left = ($vbulletin->GPC['left'] < 0 ) ? 0 : $vbulletin->GPC['left'];
    $top = ($vbulletin->GPC['top'] < 0 ) ? 0 : $vbulletin->GPC['top'];
    $height = ($vbulletin->GPC['height'] > vB_AdvancedProfilePhoto_Store::MAX_HEIGHT) ? vB_AdvancedProfilePhoto_Store::MAX_HEIGHT : $vbulletin->GPC['height'];
    $width = ($vbulletin->GPC['width'] > vB_AdvancedProfilePhoto_Store::MAX_WIDTH) ? vB_AdvancedProfilePhoto_Store::MAX_WIDTH : $vbulletin->GPC['width'];
    $enablepreview = ($vbulletin->GPC['enablepreview'] == 0 OR $vbulletin->GPC['enablepreview'] == 1) ? $vbulletin->GPC['enablepreview'] : 0;
    $target_path = $vbulletin->options['app_img_folder']."/".$vbulletin->userinfo['userid']."_".$vbulletin->userinfo['bigpicrevision'].".jpg";

    $img_editor = new vB_AdvancedProfilePhoto_Store($target_path);
    if ($img_editor)
    {
        $img_editor->generate_avatar($vbulletin->userinfo['userid'], $vbulletin->userinfo['avatarrevision'], $width, $height, $left, $top);
        $img_editor->generate_profilepic($vbulletin->userinfo['userid'], $vbulletin->userinfo['profilepicrevision'], $width, $height, $left, $top);
        $img_editor->generate_bigpicdata($width, $height, $left, $top);
        // save setting to enable/disable bigpic display
        $vbulletin->db->query_write("UPDATE " . TABLE_PREFIX . "user SET `bigpicpopup` = ". $enablepreview ." WHERE userid = ". $vbulletin->userinfo['userid']); 
    }
    unset($img_editor);

    eval(print_standard_redirect('redirect_updatethanks', true, true));
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Init post ids</title>
			<hookname>showthread_complete</hookname>
			<phpcode><![CDATA[if (isset($postids_with_big_pic) AND !empty($postids_with_big_pic))
{
    $templater = vB_Template::create('app_popup_menu');
    $templater->register('post_ids', implode(",", array_keys($postids_with_big_pic)));
    $templater->register('pic_paths', '"'.implode('","', $postids_with_big_pic).'"');
    $templater->register('pic_folder', $vbulletin->options['app_img_url']."/");
    $template_hook['showthread_below_posts'] .= $templater->render();
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Init post ids for big pics</title>
			<hookname>showthread_postbit_create</hookname>
			<phpcode><![CDATA[global $postids_with_big_pic;

if (!isset($postids_with_big_pic))
{
    $postids_with_big_pic = array();
}

if ($post['bigpicsaved'] AND $post['bigpicpopup'])
{
    $postids_with_big_pic[$post['postid']] = $post['userid']."_".$post['bigpicrevision'].".jpg";
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Delete avatar and source img on profile pic deletion</title>
			<hookname>userpicdata_delete</hookname>
			<phpcode><![CDATA[if( $this->table == 'customprofilepic' )
{
    global $vbulletin;

    // reset to the beginning so we could fetch it again
    $this->registry->db->data_seek($users, 0);
    while ($user = $this->registry->db->fetch_array($users))
    {
        $vbulletin->db->query_write("DELETE FROM " . TABLE_PREFIX . "custombigpic WHERE `userid` = ". $user['userid']);

        // mark file as removed in the user table
        $vbulletin->db->query_write("UPDATE " . TABLE_PREFIX . "user SET `bigpicsaved` = 0, `bigpicpopup` = 1 WHERE userid = ". $user['userid']);

        if($result = $vbulletin->db->query_first("SELECT bigpicrevision FROM " . TABLE_PREFIX . "user WHERE userid = ". $user['userid']))
        {
           @unlink($vbulletin->options['app_img_folder']."/".$user['userid']."_".$result['bigpicrevision'].".jpg");
        }
    }

    $userpic =& datamanager_init('Userpic_Avatar', $vbulletin, ERRTYPE_STANDARD, 'userpic');
    $userpic->condition = $this->condition;
    $userpic->delete();
}]]></phpcode>
		</plugin>
	</plugins>
	<phrases>
		<phrasetype name="Error Messages" fieldname="error">
			<phrase name="app_image_too_small" date="1298961428" username="admin" version=""><![CDATA[Image too small. It should be at least {1}x{1} pixels.]]></phrase>
			<phrase name="app_save_failed" date="1299115305" username="admin" version=""><![CDATA[Fatal error: can't save file.]]></phrase>
		</phrasetype>
		<phrasetype name="GLOBAL" fieldname="global">
			<phrase name="app_allow_fullsize" date="1298961293" username="admin" version=""><![CDATA[I allow to show full size photo where possible]]></phrase>
			<phrase name="app_annotation" date="1298961315" username="admin" version=""><![CDATA[<span style="color:red;">ATTENTION!</span> You can upload your own photo here. It will be shown as avatars and so on. Only real photos acceptable. After upload select face area, it should be well seen. Any other content violates forum rules.]]></phrase>
			<phrase name="app_confirm_photo" date="1298961337" username="admin" version=""><![CDATA[I confirm, this photo is mine]]></phrase>
			<phrase name="app_confirm_photo_face" date="1298961362" username="admin" version=""><![CDATA[I confirm, that selected my face]]></phrase>
			<phrase name="app_result" date="1298961386" username="admin" version=""><![CDATA[result:]]></phrase>
			<phrase name="app_save" date="1298961404" username="admin" version=""><![CDATA[Save]]></phrase>
		</phrasetype>
		<phrasetype name="Maintenance Tools" fieldname="maintenance">
			<phrase name="app_include_automatic_javascript_redirect" date="1297746847" username="admin" version=""><![CDATA[Include automatic javascript redirect]]></phrase>
			<phrase name="app_list_of_small_profile_photo" date="1296528391" username="admin" version=""><![CDATA[List of small profile photo]]></phrase>
			<phrase name="app_number_of_pics_to_process_per_cycle" date="1300174277" username="admin" version=""><![CDATA[Number of pics to regenerate per cycle]]></phrase>
			<phrase name="app_number_of_profilepic_to_process_per_cycle" date="1296528418" username="admin" version=""><![CDATA[Number of profile picture to process per cycle]]></phrase>
			<phrase name="app_order_by_date" date="1302084979" username="varnak" version=""><![CDATA[Sort by picture date]]></phrase>
			<phrase name="app_rebuild_profile_photo_avatar_thumbnails" date="1300174299" username="admin" version=""><![CDATA[Rebuild Profile Photos & Avatars from big pics]]></phrase>
			<phrase name="app_remove_small_profile_photo" date="1296528487" username="admin" version=""><![CDATA[Remove small profile photo]]></phrase>
		</phrasetype>
		<phrasetype name="vBulletin Settings" fieldname="vbsettings">
			<phrase name="setting_app_avatar_size_desc" date="1299827966" username="admin" version="0.1"><![CDATA[Enter avatar size (max height/width) in pixels.]]></phrase>
			<phrase name="setting_app_avatar_size_title" date="1299827966" username="admin" version="0.1"><![CDATA[Generated avatar size]]></phrase>
			<phrase name="setting_app_corners_radius_desc" date="1299827966" username="admin" version="0.1"><![CDATA[Set 0 to disable.]]></phrase>
			<phrase name="setting_app_corners_radius_title" date="1299827966" username="admin" version="0.1"><![CDATA[Avatar corners radius, pixels]]></phrase>
			<phrase name="setting_app_img_folder_desc" date="1299827966" username="admin" version="0.1"><![CDATA[Folder to store uploaded big pictures. This file path should be readable AND writeable by your web server (usually chmod 0777).]]></phrase>
			<phrase name="setting_app_img_folder_title" date="1299827966" username="admin" version="0.1"><![CDATA[Custom folder for big profile images]]></phrase>
			<phrase name="setting_app_img_url_desc" date="1300084301" username="admin" version="0.1"><![CDATA[Relative to your forums home page]]></phrase>
			<phrase name="setting_app_img_url_title" date="1300084301" username="admin" version="0.1"><![CDATA[URL to custom big profile pics]]></phrase>
			<phrase name="setting_app_opencv_cascades_path_desc" date="1300434494" username="admin" version="0.1"><![CDATA[Path to xml files, used for face detection]]></phrase>
			<phrase name="setting_app_opencv_cascades_path_title" date="1300434494" username="admin" version="0.1"><![CDATA[Path to opencv cascades]]></phrase>
			<phrase name="setting_app_profile_size_desc" date="1299827966" username="admin" version="0.1"><![CDATA[Enter profile picture size (max height/width) in pixels.]]></phrase>
			<phrase name="setting_app_profile_size_title" date="1299827966" username="admin" version="0.1"><![CDATA[Generated profilepic size]]></phrase>
			<phrase name="setting_app_selection_change_desc" date="1299827966" username="admin" version="0.1"><![CDATA[Selection is changed by jerks when you start it from the smallest value. This is done for better picture resizing. Please specify several steps in pixels.]]></phrase>
			<phrase name="setting_app_selection_change_title" date="1299827966" username="admin" version="0.1"><![CDATA[Selection change]]></phrase>
			<phrase name="settinggroup_app_settings" date="1299827966" username="admin" version="0.1"><![CDATA[Advanced Profile Photo]]></phrase>
		</phrasetype>
	</phrases>
	<options>
		<settinggroup name="app_settings" displayorder="65535">
			<setting varname="app_img_folder" displayorder="5">
				<datatype>free</datatype>
				<defaultvalue>./custombigprofilepics</defaultvalue>
			</setting>
			<setting varname="app_avatar_size" displayorder="10">
				<datatype>posint</datatype>
				<defaultvalue>120</defaultvalue>
			</setting>
			<setting varname="app_img_url" displayorder="10">
				<datatype>free</datatype>
				<defaultvalue>custombigprofilepics</defaultvalue>
			</setting>
			<setting varname="app_profile_size" displayorder="20">
				<datatype>posint</datatype>
				<defaultvalue>120</defaultvalue>
			</setting>
			<setting varname="app_corners_radius" displayorder="40">
				<datatype>posint</datatype>
				<defaultvalue>5</defaultvalue>
			</setting>
			<setting varname="app_selection_change" displayorder="50">
				<datatype>free</datatype>
				<defaultvalue>120,130,140</defaultvalue>
			</setting>
			<setting varname="app_opencv_cascades_path" displayorder="70">
				<datatype>free</datatype>
				<defaultvalue>/usr/local/share/opencv/haarcascades</defaultvalue>
			</setting>
		</settinggroup>
	</options>
	<helptopics>
	</helptopics>
	<cronentries>
	</cronentries>
	<faqentries>
	</faqentries>
</product>
